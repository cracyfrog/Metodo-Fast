<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>M√©todo Fast de Modelagem</title>
  <style>
    :root { --red:#cc0000; --red-dark:#a60000; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; }
    h1 { font-size: 22px; margin: 0 0 10px; }

    form { display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap; }
    input[type="text"] { flex:1; min-width:260px; padding:10px; border:1px solid #ccc; border-radius:8px; }
    button { padding:10px 14px; border:0; border-radius:8px; background:var(--red); color:#fff; cursor:pointer; }
    button:disabled { background:#999; cursor:default; }

    /* Bot√µes das modelagens: sempre vermelhos com texto branco */
    .models { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 6px; }
    .model {
      background: var(--red);
      color: #fff;
      border: 1px solid var(--red-dark);
      border-radius: 14px;
      padding: 8px 14px;
      cursor: pointer;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.1;
      gap: 3px;
      min-width: 190px;
      text-align: center;
    }
    .model .m-title { font-weight: 700; }
    .model .m-sub { font-size: 12px; opacity: 0.95; }
    /* Selecionado: destaque preto ao redor */
    .model.active { box-shadow: 0 0 0 3px #000; }

    details { margin:8px 0 12px; }
    summary { cursor:pointer; font-weight:600; }
    .langs { display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:6px 14px; margin-top:8px; }
    .tools { display:flex; gap:8px; margin:6px 0 12px; flex-wrap:wrap; }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:12px; }
    .card { border:1px solid #e5e5e5; border-radius:12px; overflow:hidden; background:#fff; }
    .thumb { width:100%; aspect-ratio:16/9; object-fit:cover; background:#f3f3f3; }
    .content { padding:10px; }
    .title { font-size:15px; font-weight:600; margin:0 0 6px; line-height:1.3; display:inline-block; color:#111; text-decoration:none; }
    .title:hover { text-decoration:underline; }
    .meta { color:#555; font-size:13px; }
    .badge { display:inline-block; background:#f1f1f1; padding:2px 6px; border-radius:999px; margin-right:6px; font-size:12px; }

    .loading { margin: 8px 0; }
    .empty { color:#777; margin-top:12px; }
    .row { display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>M√©todo Fast de Modelagem</h1>

  <form id="form">
    <input id="q" type="text" placeholder="Ex: marketing digital, instagram" />
    <button type="submit">Buscar</button>
  </form>

  <div class="models" id="models">
    <button class="model active" data-model="gold" type="button">
      <span class="m-title">Modelagem Gold</span>
      <span class="m-sub">üî•üî•üî•</span>
    </button>
    <button class="model" data-model="silver" type="button">
      <span class="m-title">Modelagem Silver</span>
      <span class="m-sub">üî•üî•</span>
    </button>
    <button class="model" data-model="bronze" type="button">
      <span class="m-title">Modelagem Bronze</span>
      <span class="m-sub">üî•</span>
    </button>
    <button class="model" data-model="recorrentes" type="button">
      <span class="m-title">Modelagem de Views Recorrentes</span>
      <span class="m-sub">üìà</span>
    </button>
  </div>

  <details id="langBox" open>
    <summary>Idiomas permitidos (clique para abrir/fechar)</summary>
    <div class="langs" id="langs"></div>
    <div class="tools">
      <button id="selectAll" type="button">Selecionar todos</button>
      <button id="clearAll" type="button">Limpar</button>
    </div>
  </details>

  <div class="row">
    <div id="loading" class="loading" style="display:none;">Carregando...</div>
    <div id="count"></div>
  </div>
  <div id="results" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">Nenhum v√≠deo encontrado com esses crit√©rios.</div>
  <div style="margin-top:12px;">
    <button id="loadMore" type="button" style="display:none;">Mostrar mais</button>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // Config dos modelos (mant√©m a l√≥gica ‚Äî s√≥ visual mudou)
    const MODELS = {
      gold:       { label: 'Gold',       minViews: 100_000, days: 30, maxSubs: 50_000 },
      silver:     { label: 'Silver',     minViews: 100_000, days: 90, maxSubs: 50_000 },
      bronze:     { label: 'Bronze',     minViews: 100_000, days: 90, maxSubs: 150_000 },
      recorrentes:{ label: 'Views Recorrentes', minViews: 15_000, days: 7, maxSubs: 150_000 }
    };
    const MIN_DURATION_SEC = 8 * 60; // 8 min
    const DEFAULT_LANGS = [
      ['en','Ingl√™s'], ['es','Espanhol'], ['fr','Franc√™s'], ['de','Alem√£o'],
      ['pt','Portugu√™s'], ['it','Italiano'], ['ru','Russo'], ['ja','Japon√™s'],
      ['ko','Coreano'], ['nl','Holand√™s'], ['pl','Polon√™s'], ['el','Grego'],
      ['ro','Romeno'], ['da','Dinamarqu√™s'], ['no','Noruegu√™s'], ['ga','Irland√™s']
    ];

    // Estado
    let state = {
      q: '',
      model: 'gold',
      pages: 1,
      maxPages: 2,
      langs: DEFAULT_LANGS.map(([code]) => code),
      items: []
    };

    // Renderiza checkboxes de idiomas
    function renderLangs() {
      const container = $('#langs');
      container.innerHTML = '';
      DEFAULT_LANGS.forEach(([code, label]) => {
        const id = `lang_${code}`;
        const wrap = document.createElement('label');
        wrap.htmlFor = id;
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.value = code;
        cb.checked = state.langs.includes(code);
        cb.addEventListener('change', () => {
          if (cb.checked) {
            if (!state.langs.includes(code)) state.langs.push(code);
          } else {
            state.langs = state.langs.filter(c => c !== code);
          }
        });
        wrap.appendChild(cb);
        wrap.appendChild(document.createTextNode(' ' + label));
        container.appendChild(wrap);
      });
    }
    renderLangs();

    // Sele√ß√£o de modelo (mant√©m todos vermelhos; s√≥ adiciona contorno preto no ativo)
    $$('#models .model').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('#models .model').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.model = btn.dataset.model;
        state.pages = 1; // reset
        if (state.q) search();
      });
    });

    // Selecionar/Limpar idiomas
    $('#selectAll').addEventListener('click', () => {
      state.langs = DEFAULT_LANGS.map(([c]) => c);
      renderLangs();
    });
    $('#clearAll').addEventListener('click', () => {
      state.langs = [];
      renderLangs();
    });

    function formatNumber(n) {
      return new Intl.NumberFormat('pt-BR').format(n);
    }
    function elapsed(publishedAt) {
      const diff = Date.now() - new Date(publishedAt).getTime();
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      if (days <= 0) return 'hoje';
      if (days === 1) return 'h√° 1 dia';
      return `h√° ${days} dias`;
    }

    async function search() {
      $('#loading').style.display = 'block';
      $('#empty').style.display = 'none';
      $('#loadMore').style.display = 'none';

      try {
        const cfg = MODELS[state.model];
        const params = new URLSearchParams({
          q: state.q,
          minViews: String(cfg.minViews),
          days: String(cfg.days),
          maxSubs: String(cfg.maxSubs),
          minDurationSec: String(MIN_DURATION_SEC),
          pages: String(state.pages),
          langs: state.langs.join(','),
          cb: Date.now().toString()
        });
        const url = `/api/search?${params.toString()}`;
        const r = await fetch(url);
        if (!r.ok) {
          const t = await r.text();
          throw new Error(`Erro na API: ${r.status} ${t}`);
        }
        const data = await r.json();
        const items = data.items || [];

        state.items = items;
        renderResults();
        if (state.pages < state.maxPages) {
          $('#loadMore').style.display = 'inline-block';
        } else {
          $('#loadMore').style.display = 'none';
        }
      } catch (e) {
        console.error(e);
        alert('Falha ao buscar v√≠deos. Veja o console para detalhes.');
      } finally {
        $('#loading').style.display = 'none';
      }
    }

    function renderResults() {
      const container = $('#results');
      container.innerHTML = '';
      $('#count').textContent = state.items.length ? `${state.items.length} resultados` : '';

      if (!state.items.length) {
        $('#empty').style.display = 'block';
        return;
      }

      const frag = document.createDocumentFragment();
      state.items.forEach(v => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <a href="${v.url}" target="_blank" rel="noopener noreferrer">
            <img class="thumb" src="${v.thumbnail || ''}" alt="thumb" loading="lazy" />
          </a>
          <div class="content">
            <a class="title" href="${v.url}" target="_blank" rel="noopener noreferrer">${v.title}</a>
            <div class="meta">
              <span class="badge">üëÄ ${formatNumber(v.viewCount)}</span>
              <span class="badge">üë§ ${v.subscriberCount != null ? formatNumber(v.subscriberCount) + ' subs' : 'subs ocultos'}</span>
              <span class="badge">üóìÔ∏è ${elapsed(v.publishedAt)}</span>
              <span class="badge">‚è±Ô∏è ${Math.round(v.durationSec/60)} min</span>
              ${v.language ? `<span class="badge">üåê ${v.language}</span>` : ''}
              <div style="margin-top:6px;">Canal: ${v.channelTitle}</div>
            </div>
          </div>
        `;
        frag.appendChild(card);
      });

      container.appendChild(frag);
    }

    // Form submit
    $('#form').addEventListener('submit', (e) => {
      e.preventDefault();
      const q = $('#q').value.trim();
      if (!q) return;
      state.q = q;
      state.pages = 1;
      search();
    });

    // Mostrar mais
    $('#loadMore').addEventListener('click', () => {
      if (state.pages < state.maxPages) {
        state.pages += 1;
        search();
      }
    });
  </script>
</body>
</html>
