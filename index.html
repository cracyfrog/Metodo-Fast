<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Modelagem Channels</title>
  <style>
    :root { --violet:#8b5cf6; --violet-dark:#6d28d9; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 24px; color:#111; }
    h1 { font-size: 22px; margin: 0 0 6px; display:flex; align-items:center; gap:8px; }
    .hint { font-size: 14px; color:#444; margin: 4px 0 14px; font-weight: 400; line-height:1.4; }

    form { display:flex; gap:8px; margin-bottom:6px; flex-wrap:wrap; }
    input[type="text"] { flex:1; min-width:260px; padding:10px; border:1px solid #ccc; border-radius:8px; }
    button { padding:10px 14px; border:0; border-radius:8px; background:var(--violet); color:#fff; cursor:pointer; }
    button:disabled { background:#999; cursor:default; }

    /* BotÃµes das modelagens: roxo claro com texto branco, e contorno preto no selecionado */
    .models { display:flex; flex-wrap:wrap; gap:10px; margin:10px 0 6px; }
    .model {
      background: var(--violet);
      color: #fff;
      border: 1px solid var(--violet-dark);
      border-radius: 14px;
      padding: 8px 14px;
      cursor: pointer;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      line-height: 1.1;
      gap: 3px;
      min-width: 190px;
      text-align: center;
    }
    .model .m-title { font-weight: 700; }
    .model .m-sub { font-size: 12px; opacity: 0.95; }
    .model.active { box-shadow: 0 0 0 3px #000; }

    details { margin:8px 0 12px; }
    summary { cursor:pointer; font-weight:600; }
    .langs { display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap:6px 14px; margin-top:8px; }
    .tools { display:flex; gap:8px; margin:6px 0 12px; flex-wrap:wrap; }

    .grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap:12px; }
    .card { border:1px solid #e5e5e5; border-radius:12px; overflow:hidden; background:#fff; }
    .thumb { width:100%; aspect-ratio:16/9; object-fit:cover; background:#f3f3f3; }
    .content { padding:10px; }
    .title { font-size:15px; font-weight:600; margin:0 0 6px; line-height:1.3; display:inline-block; color:#111; text-decoration:none; }
    .title:hover { text-decoration:underline; }
    .meta { color:#555; font-size:13px; }
    .badge { display:inline-block; background:#f1f1f1; padding:2px 6px; border-radius:999px; margin-right:6px; font-size:12px; }

    .loading { margin: 8px 0; }
    .empty { color:#777; margin-top:12px; }
    .row { display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>ğŸ”® Modelagem Channels</h1>
  <p class="hint">Busque por palavras chave do seu nicho, no idioma do canal que vocÃª quer criar.</p>

  <form id="form">
    <input id="q" type="text" placeholder="Ex: marketing digital, instagram" />
    <button type="submit">Buscar</button>
  </form>
  <p class="hint">
    Os nÃ­veis Gold, Silver e Bronze vÃ£o te mostrar apenas vÃ­deos quentes, dentro da nossa estratÃ©gia de traÃ§Ã£o rÃ¡pida, com altas chances de viralizaÃ§Ã£o.
    Pra uma modelagem mais abrangente, pode fazer direto no Youtube, manualmente. Essa ferramenta Ã© pra te mostrar somente o que tem mais potencial viral no momento da busca!
    Usamos parÃ¢metros variados nos 3 nÃ­veis, mas todos focando em resultados rÃ¡pidos.
  </p>

  <div class="models" id="models">
    <button class="model" data-model="subnicho" type="button">
      <span class="m-title">Oportunidade de Subnicho</span>
      <span class="m-sub">ğŸ’</span>
    </button>

    <button class="model active" data-model="gold" type="button">
      <span class="m-title">Modelagem Gold</span>
      <span class="m-sub">ğŸ”¥ğŸ”¥ğŸ”¥</span>
    </button>
    <button class="model" data-model="silver" type="button">
      <span class="m-title">Modelagem Silver</span>
      <span class="m-sub">ğŸ”¥ğŸ”¥</span>
    </button>
    <button class="model" data-model="bronze" type="button">
      <span class="m-title">Modelagem Bronze</span>
      <span class="m-sub">ğŸ”¥</span>
    </button>

    <button class="model" data-model="fresh" type="button">
      <span class="m-title">Fresh</span>
      <span class="m-sub">ğŸ”</span>
    </button>

    <button class="model" data-model="recorrentes" type="button">
      <span class="m-title">Modelagem de Views Recorrentes</span>
      <span class="m-sub">ğŸ“ˆ</span>
    </button>
  </div>

  <details id="langBox" open>
    <summary>Idiomas permitidos (selecione o mesmo idioma das palavras chave, pra o filtro funcionar melhor)</summary>
    <div class="langs" id="langs"></div>
    <div class="tools">
      <button id="selectAll" type="button">Selecionar todos</button>
      <button id="clearAll" type="button">Limpar</button>
    </div>
  </details>

  <div class="row">
    <div id="loading" class="loading" style="display:none;">Carregando...</div>
    <div id="count"></div>
  </div>
  <div id="results" class="grid"></div>
  <div id="empty" class="empty" style="display:none;">Nenhum resultado encontrado com esses critÃ©rios.</div>
  <div style="margin-top:12px;">
    <button id="loadMore" type="button" style="display:none;">Mostrar mais</button>
  </div>

  <script>
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));

    // Config dos modelos
    // ObservaÃ§Ã£o:
    // - "fresh" mantÃ©m a lÃ³gica anterior de vÃ­deos recentes (min 15k views, 7 dias, canais atÃ© 150k).
    // - "recorrentes" agora busca canais com streak (14 vÃ­deos seguidos >= 15k views em atÃ© 30 dias, atÃ© 150k subs).
    // - "subnicho" procura oportunidade de canal que teve pelo menos 1 vÃ­deo >= 500k views nos Ãºltimos 60 dias.
    const MODELS = {
      subnicho:   { label: 'Oportunidade de Subnicho', type: 'channel_by_hot_video', minViews: 500_000, days: 60, maxSubs: null, /* qualquer quantidade */ },
      gold:       { label: 'Gold',       type: 'video', minViews: 100_000, days: 30, maxSubs: 50_000 },
      silver:     { label: 'Silver',     type: 'video', minViews: 100_000, days: 90, maxSubs: 50_000 },
      bronze:     { label: 'Bronze',     type: 'video', minViews: 100_000, days: 90, maxSubs: 150_000 },
      fresh:      { label: 'Fresh',      type: 'video', minViews: 15_000, days: 7,  maxSubs: 150_000 },
      recorrentes:{ label: 'Views Recorrentes', type: 'channel_streak', streakVideos: 14, streakMinViews: 15_000, streakDays: 30, maxSubs: 150_000, minDurationSec: 0 }
    };
    const MIN_DURATION_SEC = 8 * 60; // 8 min
    const DEFAULT_LANGS = [
      ['en','InglÃªs'], ['es','Espanhol'], ['fr','FrancÃªs'], ['de','AlemÃ£o'],
      ['pt','PortuguÃªs'], ['it','Italiano'], ['ru','Russo'], ['ja','JaponÃªs'],
      ['ko','Coreano'], ['nl','HolandÃªs'], ['pl','PolonÃªs'], ['el','Grego'],
      ['ro','Romeno'], ['da','DinamarquÃªs'], ['no','NorueguÃªs'], ['ga','IrlandÃªs']
    ];

    // Estado
    let state = {
      q: '',
      model: 'gold',
      pages: 1,
      maxPages: 2,
      langs: DEFAULT_LANGS.map(([code]) => code),
      items: []
    };

    // Renderiza checkboxes de idiomas
    function renderLangs() {
      const container = $('#langs');
      container.innerHTML = '';
      DEFAULT_LANGS.forEach(([code, label]) => {
        const id = `lang_${code}`;
        const wrap = document.createElement('label');
        wrap.htmlFor = id;
        wrap.style.display = 'flex';
        wrap.style.alignItems = 'center';
        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.id = id;
        cb.value = code;
        cb.checked = state.langs.includes(code);
        cb.addEventListener('change', () => {
          if (cb.checked) {
            if (!state.langs.includes(code)) state.langs.push(code);
          } else {
            state.langs = state.langs.filter(c => c !== code);
          }
        });
        wrap.appendChild(cb);
        wrap.appendChild(document.createTextNode(' ' + label));
        container.appendChild(wrap);
      });
    }
    renderLangs();

    // SeleÃ§Ã£o de modelo
    $$('#models .model').forEach(btn => {
      btn.addEventListener('click', () => {
        $$('#models .model').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        state.model = btn.dataset.model;
        state.pages = 1; // reset
        if (state.q) search();
      });
    });

    // Selecionar/Limpar idiomas
    $('#selectAll').addEventListener('click', () => {
      state.langs = DEFAULT_LANGS.map(([c]) => c);
      renderLangs();
    });
    $('#clearAll').addEventListener('click', () => {
      state.langs = [];
      renderLangs();
    });

    function formatNumber(n) {
      return new Intl.NumberFormat('pt-BR').format(n);
    }
    function elapsed(publishedAt) {
      const diff = Date.now() - new Date(publishedAt).getTime();
      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      if (days <= 0) return 'hoje';
      if (days === 1) return 'hÃ¡ 1 dia';
      return `hÃ¡ ${days} dias`;
    }

    async function search() {
      $('#loading').style.display = 'block';
      $('#empty').style.display = 'none';
      $('#loadMore').style.display = 'none';

      try {
        const cfg = MODELS[state.model];
        const params = new URLSearchParams({
          q: state.q,
          days: cfg.days != null ? String(cfg.days) : '',
          minViews: cfg.minViews != null ? String(cfg.minViews) : '',
          maxSubs: cfg.maxSubs != null ? String(cfg.maxSubs) : '',
          minDurationSec: String(cfg.minDurationSec != null ? cfg.minDurationSec : MIN_DURATION_SEC),
          pages: String(state.pages),
          langs: state.langs.join(','),
          type: cfg.type || 'video', // informa o modo (video, channel_by_hot_video, channel_streak)
          cb: Date.now().toString()
        });

        // ParÃ¢metros especiais (streak para "Modelagem de Views Recorrentes")
        if (cfg.type === 'channel_streak') {
          params.set('streakVideos', String(cfg.streakVideos));
          params.set('streakMinViews', String(cfg.streakMinViews));
          params.set('streakDays', String(cfg.streakDays));
        }

        const url = `/api/search?${params.toString()}`;
        const r = await fetch(url);
        if (!r.ok) {
          const t = await r.text();
          throw new Error(`Erro na API: ${r.status} ${t}`);
        }
        const data = await r.json();
        const items = data.items || [];

        state.items = items;
        renderResults();
        if (state.pages < state.maxPages && items.length) {
          $('#loadMore').style.display = 'inline-block';
        } else {
          $('#loadMore').style.display = 'none';
        }
      } catch (e) {
        console.error(e);
        alert('Falha ao buscar resultados. Veja o console para detalhes.');
      } finally {
        $('#loading').style.display = 'none';
      }
    }

    function renderResults() {
      const container = $('#results');
      container.innerHTML = '';
      $('#count').textContent = state.items.length ? `${state.items.length} resultados` : '';

      if (!state.items.length) {
        $('#empty').style.display = 'block';
        return;
      }

      const frag = document.createDocumentFragment();
      state.items.forEach(v => {
        const link = v.url || v.videoUrl || v.channelUrl || '#';
        const title = v.title || v.channelTitle || 'Resultado';
        const thumb = v.thumbnail || v.channelThumbnail || '';

        const badges = [];
        if (typeof v.viewCount === 'number') badges.push(`ğŸ‘€ ${formatNumber(v.viewCount)}`);
        if (typeof v.subscriberCount === 'number') badges.push(`ğŸ‘¤ ${formatNumber(v.subscriberCount)} subs`);
        if (v.publishedAt) badges.push(`ğŸ—“ï¸ ${elapsed(v.publishedAt)}`);
        if (typeof v.durationSec === 'number') badges.push(`â±ï¸ ${Math.round(v.durationSec/60)} min`);
        if (v.language) badges.push(`ğŸŒ ${v.language}`);
        if (v.streakCount || v.streakVideos) {
          const sc = v.streakCount || v.streakVideos;
          badges.push(`ğŸ“ˆ ${sc} vÃ­deos seguidos`);
        }

        const channelLine = v.channelTitle ? `<div style="margin-top:6px;">Canal: ${v.channelTitle}</div>` : '';

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <a href="${link}" target="_blank" rel="noopener noreferrer">
            <img class="thumb" src="${thumb}" alt="thumb" loading="lazy" />
          </a>
          <div class="content">
            <a class="title" href="${link}" target="_blank" rel="noopener noreferrer">${title}</a>
            <div class="meta">
              ${badges.map(b => `<span class="badge">${b}</span>`).join(' ')}
              ${channelLine}
            </div>
          </div>
        `;
        frag.appendChild(card);
      });

      container.appendChild(frag);
    }

    // Form submit
    $('#form').addEventListener('submit', (e) => {
      e.preventDefault();
      const q = $('#q').value.trim();
      if (!q) return;
      state.q = q;
      state.pages = 1;
      search();
    });

    // Mostrar mais
    $('#loadMore').addEventListener('click', () => {
      if (state.pages < state.maxPages) {
        state.pages += 1;
        search();
      }
    });
  </script>
</body>
</html>
